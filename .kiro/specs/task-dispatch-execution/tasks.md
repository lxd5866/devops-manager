# 任务下发执行系统实现计划

## 实现任务列表

- [x] 1. 完善数据库模型自动迁移
  - 在 `server/pkg/database/mysql.go` 的 autoMigrate 函数中添加 Task、Command、CommandHost、CommandResult 模型
  - 确保数据库表结构与现有 SQL schema 一致
  - 验证模型关联关系正确配置
  - _需求: 1.1, 2.3_

- [x] 2. 重构 TaskService 集成数据库操作
  - 替换 `server/pkg/service/task_service.go` 中的内存存储为 GORM 数据库操作
  - 重构 CreateTask 方法实现数据库持久化，包括创建 Command 和 CommandHost 记录
  - 重构 GetTask、GetTasks 等查询方法使用数据库
  - 实现任务分解逻辑，为每个目标主机创建对应的 Command 和 CommandHost 记录
  - _需求: 1.1, 1.2, 1.4, 2.3_

- [x] 3. 实现 TaskService 的任务下发功能
  - 重构 TaskService 中的 StartTask 方法实现真正的任务下发逻辑
  - 添加与 gRPC 控制器的集成接口，支持命令下发到 Agent
  - 实现任务状态管理和 CommandHost 状态更新
  - 添加事务管理确保数据一致性
  - _需求: 1.1, 1.2, 1.5, 2.1_

- [x] 4. 在 TaskService 中实现命令执行结果处理
  - 实现 HandleCommandResult 方法处理 Agent 返回的执行结果
  - 更新 CommandHost 状态和执行结果到数据库
  - 实现任务进度计算和状态更新逻辑
  - 添加执行时长统计和成功率计算
  - _需求: 2.2, 2.3, 4.1, 4.2_

- [x] 5. 增强 gRPC 任务控制器的命令下发功能
  - 修改 `server/pkg/controller/grpc_task_controller.go` 的 handleCommandResult 方法
  - 集成 TaskService 的 HandleCommandResult 方法
  - 实现 Agent 连接管理和命令路由功能
  - 添加连接池管理和心跳检测机制
  - _需求: 1.5, 2.1, 2.2, 3.3_

- [x] 6. 重构任务状态监控和进度跟踪
  - 重构 TaskService 中的 GetTaskStatus 和 GetTaskProgress 方法使用数据库
  - 添加按主机、状态筛选的查询功能
  - 实现任务执行统计和报告功能
  - 扩展现有的 HTTP 任务控制器调用重构后的 TaskService 方法
  - _需求: 2.3, 2.4, 4.3, 4.4_

- [x] 7. 实现超时和异常处理机制
  - 在 TaskService 中实现命令超时处理逻辑
  - 添加 Agent 连接状态监控和异常处理
  - 重构 CancelTask 方法的数据库版本，支持任务取消和命令中断
  - 添加错误信息收集和记录机制
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 8. 优化数据库操作和性能
  - 实现批量更新 CommandHost 状态的数据库操作
  - 添加数据库事务管理确保数据一致性
  - 优化任务和命令查询的数据库索引
  - 实现任务历史记录的清理机制
  - _需求: 5.4, 4.5_

- [x] 9. 集成 Redis 缓存提升性能
  - 在 TaskService 中使用现有的 Redis 客户端缓存频繁查询的任务状态信息
  - 实现任务执行进度的缓存机制
  - 添加缓存失效和更新策略
  - 优化大量并发查询的性能
  - _需求: 5.1, 5.2_

- [x] 10. 实现任务队列和并发控制
  - 在 TaskService 中创建任务队列机制控制并发执行数量
  - 实现基于主机负载的任务分发策略
  - 添加任务优先级和调度算法
  - 实现系统负载监控和自适应调节
  - _需求: 5.5, 5.1, 5.3_

- [x] 11. 完善日志记录和审计功能
  - 增强任务执行过程的详细日志记录
  - 实现命令执行历史的完整审计追踪
  - 添加执行统计信息的收集和存储
  - 实现日志查询和分析接口
  - _需求: 4.1, 4.2, 4.3, 4.5_

- [x] 12. 集成和端到端测试验证
  - 将所有组件集成到现有系统中
  - 验证任务下发到执行的完整流程
  - 测试异常场景和错误处理机制
  - 验证性能指标和系统稳定性
  - _需求: 所有需求的综合验证_

- [x] 13. 编写单元测试
  - 为重构后的 TaskService 核心方法编写单元测试
  - 为 gRPC 控制器的消息处理编写测试
  - 为数据模型状态转换编写测试
  - 为错误处理机制编写异常场景测试
  - _需求: 代码质量保证_

- [x] 14. 编写集成测试
  - 编写 Server-Agent 通信的端到端测试
  - 编写数据库操作的事务一致性测试
  - 编写多任务并发执行的集成测试
  - 编写故障恢复和异常处理的集成测试
  - _需求: 系统集成验证_

- [x] 15. 性能测试和优化
  - 编写大规模 Agent 连接的性能测试
  - 编写批量任务执行的压力测试
  - 编写长时间运行的内存泄漏测试
  - 根据测试结果进行性能优化
  - _需求: 性能指标验证_